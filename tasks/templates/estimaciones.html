{% extends 'base.html' %}

{% block content %}
<style>
  body {
    background: linear-gradient(-45deg, #fefcef, #bfc6c7, #52b3c0, #00cccc);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .form-container {
    background-color: #ffffffdd;
    backdrop-filter: blur(10px);
    padding: 2.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-left: 6px solid #00cccc;
    height: 100%;
  }

  .form-title {
    color: #003035;
  }

  .form-label {
    font-weight: 600;
    color: #003035;
  }

  .section-title {
    color: #cc0000;
    font-weight: bold;
    font-size: 1.4rem;
    margin-top: 2rem;
  }

  .btn-calculate {
    background-color: #00cccc;
    border: none;
    color: white;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }

  .btn-calculate:hover {
    background-color: #52b3c0;
    color: #003035;
  }

  #map {
    height: 100%;
    width: 100%;
    min-height: 600px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }
</style>

<div class="full-width-container mt-5 animate__animated animate__fadeIn">
  <div class="row">
    <!-- Formulario -->
    <div class="col-md-6 col-no-padding">
      <div class="form-container animate__animated animate__zoomIn">
        <h1 class="text-center form-title mb-4">Estimación de Propiedad</h1>

        <!-- Input para búsqueda general -->
        <div class="mb-4">
          <input id="searchBox" type="text" class="form-control form-control-lg" placeholder="Buscar dirección..." />
        </div>

        <form class="row g-3 needs-validation" novalidate>
          <div class="col-md-4">
            <label class="form-label">Tipo de propiedad</label>
            <select id="tipo_propiedad" class="form-select" required>
              <option selected disabled value="">Elige una opción...</option>
              <option>Casa</option>
              <option>Departamento</option>
              <option>Terreno</option>
            </select>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Calle</label>
            <input id="calle" type="text" class="form-control" placeholder="Introduce una calle válida." required>
            <div class="invalid-feedback">Introduce una calle válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Colonia</label>
            <input class="form-control" list="datalistColonia" id="colonia" placeholder="Escribe para buscar...">
              <datalist id="datalistColonia">
                {% for colonia in colonias %}
                  <option value="{{ colonia.nombre }}"></option>
                {% endfor %}
              </datalist>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Código Postal</label>
            <input class="form-control" list="datalistCP" id="cp" placeholder="Escribe para buscar..." name="cp">
              <datalist id="datalistCP">
                {% for cp in codigos_postales %}
                  <option value="{{ cp.codigo }}"></option>
                {% endfor %}
              </datalist>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Alcaldía o Municipio</label>
            <input class="form-control" list="datalistMunicipio" id="municipio" placeholder="Escribe para buscar...">
              <datalist id="datalistMunicipio">
                {% for municipio in municipios %}
                  <option value="{{ municipio.nombre }}"></option>
                {% endfor %}
              </datalist>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado</label>
            <input class="form-control" list="datalistEstado" id="estado" placeholder="Escribe para buscar...">
            <datalist id="datalistEstado">
              {% for estado in estados %}
                <option value="{{ estado.nombre }}"></option>
              {% endfor %}
            </datalist>           
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Recámaras</label>
            <input id="recamaras" type="number" class="form-control" min="0" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Sanitarios</label>
            <input id="sanitarios" type="number" class="form-control" min="0" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Estacionamiento</label>
            <input id="estacionamiento" type="number" class="form-control" min="0" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-5">
            <label class="form-label">Comentarios</label>
            <textarea id="comentarios" class="form-control" rows="2" placeholder="Opcional..."></textarea>
          </div>

          <!-- Sección de metraje -->
          <div class="col-12 mt-4">
            <span class="section-title">Metraje</span>
          </div>

          <div class="col-md-4">
            <label class="form-label">Terreno (m²)</label>
            <input id="terreno" type="number" class="form-control" min="0" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Construcción (m²)</label>
            <input id="construccion" type="number" class="form-control" min="0" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado de conservación</label>
            <select id="estado_conservacion" class="form-select" required>
              <option selected disabled value="">Selecciona un nivel...</option>
              <option>Excelente</option>
              <option>Bueno</option>
              <option>Regular</option>
              <option>Malo</option>
            </select>
            <div class="invalid-feedback">Selecciona un estado de conservación.</div>
          </div>

          <div class="col-12 text-end mt-4">
            <button type="submit" class="btn btn-calculate btn-lg animate__animated animate__pulse">Calcular</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Mapa -->
    <div class="col-md-6">
      <div id="map"></div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Filtrar colonias y actualizar el mapa cuando se selecciona una alcaldía
    $('#municipio').on('change', function() {
        const municipioId = $(this).val();
        const municipioNombre = $(this).find('option:selected').text().trim();
        console.log('Alcaldía seleccionada:', municipioId, municipioNombre); // Depuración

        if (municipioId && municipioNombre) {
            // Actualizar el mapa con la alcaldía seleccionada
            actualizarMapaConAlcaldia(municipioNombre);

            // Filtrar colonias según la alcaldía
            $.ajax({
                url: '/obtener_colonias/',
                data: { 'municipio_id': municipioId },
                success: function(data) {
                    console.log('Colonias recibidas:', data); // Depuración
                    $('#colonia').empty().append('<option selected disabled value="">Elige una opción...</option>');
                    $.each(data, function(index, colonia) {
                        $('#colonia').append(`<option value="${colonia.id_colonia}">${colonia.nombre}</option>`);
                    });
                    $('#cp').empty().append('<option selected disabled value="">Elige una opción...</option>');
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener colonias:', status, error);
                }
            });
        } else {
            $('#colonia').empty().append('<option selected disabled value="">Elige una opción...</option>');
            $('#cp').empty().append('<option selected disabled value="">Elige una opción...</option>');
        }
    });

    // Filtrar códigos postales cuando se selecciona una colonia
    $('#colonia').on('change', function() {
        const coloniaId = $(this).val();
        console.log('Colonia seleccionada:', coloniaId); // Depuración
        if (coloniaId) {
            $.ajax({
                url: '/obtener_codigos_postales/',
                data: { 'colonia_id': coloniaId },
                success: function(data) {
                    console.log('Códigos postales recibidos:', data); // Depuración
                    $('#cp').empty().append('<option selected disabled value="">Elige una opción...</option>');
                    $.each(data, function(index, codigo) {
                        $('#cp').append(`<option value="${codigo.id_codigo_postal}">${codigo.codigo}</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener códigos postales:', status, error);
                }
            });
        } else {
            $('#cp').empty().append('<option selected disabled value="">Elige una opción...</option>');
        }
    });
});

let map, marker, geocoder;

function initMap() {
    const centro = { lat: 19.4326, lng: -99.1332 };
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: centro,
    });

    marker = new google.maps.Marker({ position: centro, map: map });
    geocoder = new google.maps.Geocoder();

    const input = document.getElementById("searchBox");
    const autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: "mx" },
        fields: ["address_components", "geometry"],
    });

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            console.error('No se encontró la geometría del lugar'); // Depuración
            return;
        }

        map.setCenter(place.geometry.location);
        map.setZoom(16);
        marker.setPosition(place.geometry.location);

        const components = place.address_components;
        const getComp = (type) =>
            components.find((comp) => comp.types.includes(type))?.long_name || "";

        const calle = getComp("route");
        const numero = getComp("street_number");
        document.getElementById("calle").value = `${calle || ''} ${numero || ''}`.trim();

        const colonia = getComp("sublocality_level_1") || getComp("neighborhood") || "";
        if (colonia) document.getElementById("colonia").value = colonia;

        const cp = getComp("postal_code") || "";
        if (cp) document.getElementById("cp").value = cp;

        const municipio = getComp("administrative_area_level_2") || "";
        if (municipio) document.getElementById("municipio").value = municipio;
    });

    ["calle", "colonia", "cp", "municipio"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", actualizarMapa);
    });
}

function actualizarMapa() {
    const calle = document.getElementById("calle")?.value || "";
    const colonia = document.getElementById("colonia")?.value || "";
    const cp = document.getElementById("cp")?.value || "";
    const municipio = $('#municipio option:selected').text().trim() || "";
    const estado = "Ciudad de México";

    const direccion = `${calle}, ${colonia}, ${cp}, ${municipio}, ${estado}, México`.trim();
    console.log('Geocodificando dirección:', direccion); // Depuración

    if (direccion) {
        geocoder.geocode({ address: direccion }, function (results, status) {
            if (status === "OK" && results[0]) {
                const location = results[0].geometry.location;
                console.log('Coordenadas encontradas:', location.lat(), location.lng()); // Depuración
                map.setCenter(location);
                marker.setPosition(location);
                map.setZoom(14); // Zoom para direcciones específicas
            } else {
                console.error('Error al geocodificar:', status, results); // Depuración
            }
        });
    }
}

function actualizarMapaConAlcaldia(municipioNombre) {
    const estado = "Ciudad de México";
    const direccion = `${municipioNombre}, ${estado}, México`.trim();
    console.log('Geocodificando alcaldía:', direccion); // Depuración

    if (municipioNombre && geocoder) {
        geocoder.geocode({ address: direccion }, function (results, status) {
            if (status === "OK" && results[0]) {
                const location = results[0].geometry.location;
                console.log('Coordenadas de la alcaldía:', location.lat(), location.lng()); // Depuración
                map.setCenter(location);
                marker.setPosition(location);
                map.setZoom(12); // Zoom para mostrar toda la alcaldía
            } else {
                console.error('Error al geocodificar la alcaldía:', status, results); // Depuración
            }
        });
    } else {
        console.error('Geocoder no inicializado o municipio inválido:', municipioNombre);
    }
}

// Asegurar que initMap se llame correctamente
window.initMap = initMap;
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDldEaEtV3NdG-fY-us0SmbBSh8RHibnpU&libraries=places&callback=initMap"
    async defer>
</script>

{% endblock %}