{% extends 'base.html' %}

{% block content %}
<style>
  body {
    background: linear-gradient(-45deg, #fefcef, #bfc6c7, #52b3c0, #00cccc);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .form-container {
    background-color: #ffffffdd;
    backdrop-filter: blur(10px);
    padding: 2.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-left: 6px solid #00cccc;
    height: 100%;
  }

  .form-title {
    color: #003035;
  }

  .form-label {
    font-weight: 600;
    color: #003035;
  }

  .section-title {
    color: #cc0000;
    font-weight: bold;
    font-size: 1.4rem;
    margin-top: 2rem;
  }

  .btn-calculate {
    background-color: #00cccc;
    border: none;
    color: white;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }

  .btn-calculate:hover {
    background-color: #52b3c0;
    color: #003035;
  }

  #map {
    height: 100%;
    width: 100%;
    min-height: 600px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }
</style>

<div class="full-width-container mt-5 animate__animated animate__fadeIn">
  <div class="row">
    <!-- Formulario -->
    <div class="col-md-6 col-no-padding">
      <div class="form-container animate__animated animate__zoomIn">
        <h1 class="text-center form-title mb-4">Estimación de Propiedad</h1>

        <form class="row g-3 needs-validation" novalidate>

          <!-- BARRA DE BÚSQUEDA CON AUTOCOMPLETADO -->
          <div class="container mb-4">
            <input id="searchBox" class="form-control form-control-lg" type="text" placeholder="Buscar dirección, colonia o municipio..." />
          </div>

          <div class="col-md-4">
            <label class="form-label">Tipo de propiedad</label>
            <select class="form-select" required>
              <option selected disabled value="">Elige una opción...</option>
              <option>Casa</option>
              <option>Departamento</option>
              <option>Terreno</option>
            </select>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Calle</label>
            <input type="text" class="form-control" required>
            <div class="invalid-feedback">Introduce una calle válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Colonia</label>
            <select class="form-select" required>
              <option selected disabled value="">Elige una opción...</option>
              <option>...</option>
            </select>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Código Postal</label>
            <input type="text" class="form-control" required pattern="\d{5}">
            <div class="invalid-feedback">Introduce un código postal válido (5 dígitos).</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Alcaldía o Municipio</label>
            <select class="form-select" required>
              <option selected disabled value="">Elige una opción...</option>
              <option>...</option>
            </select>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado</label>
            <select class="form-select" required>
              <option selected disabled value="">Elige una opción...</option>
              <option>...</option>
            </select>
            <div class="invalid-feedback">Selecciona una opción válida.</div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Recámaras</label>
            <input type="number" class="form-control" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Sanitarios</label>
            <input type="number" class="form-control" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Estacionamiento</label>
            <input type="number" class="form-control" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-5">
            <label class="form-label">Comentarios</label>
            <textarea class="form-control" rows="2"></textarea>
          </div>

          <!-- Sección de metraje -->
          <div class="col-12 mt-4">
            <span class="section-title">Metraje</span>
          </div>

          <div class="col-md-4">
            <label class="form-label">Terreno (m²)</label>
            <input type="number" class="form-control" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Construcción (m²)</label>
            <input type="number" class="form-control" required>
            <div class="invalid-feedback">Campo requerido.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado de conservación</label>
            <select class="form-select" required>
              <option selected disabled value="">Selecciona un nivel...</option>
              <option>Excelente</option>
              <option>Bueno</option>
              <option>Regular</option>
              <option>Malo</option>
            </select>
            <div class="invalid-feedback">Selecciona un estado de conservación.</div>
          </div>

          <div class="col-12 text-end mt-4">
            <button type="submit" class="btn btn-calculate btn-lg animate__animated animate__pulse">Calcular</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Mapa -->
    <div class="col-md-6">
      <div id="map"></div>
    </div>
  </div>
</div>

<!-- Google Maps y Geocoding Script -->
<script>
  let map;
  let marker;
  let geocoder;
  let autocomplete;

  function initMap() {
    const centro = { lat: 19.4326, lng: -99.1332 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 12,
      center: centro,
    });

    marker = new google.maps.Marker({
      position: centro,
      map: map,
    });

    geocoder = new google.maps.Geocoder();

    // Autocompletado
    const input = document.getElementById("searchBox");
    autocomplete = new google.maps.places.Autocomplete(input, {
      componentRestrictions: { country: "mx" },
      fields: ["address_components", "geometry"],
    });

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;

      map.setCenter(place.geometry.location);
      map.setZoom(16);
      marker.setPosition(place.geometry.location);

      // Extraer y llenar datos en el formulario
      const components = place.address_components;

      const getComp = (type) =>
        components.find((comp) => comp.types.includes(type))?.long_name || "";

      document.querySelector("input[placeholder='Introduce una calle válida.']").value = getComp("route");
      document.querySelector("select.form-select[required]").value = getComp("sublocality_level_1") || getComp("neighborhood");
      document.querySelector("input[pattern='\\d{5}']").value = getComp("postal_code");
      document.querySelectorAll("select.form-select[required]")[1].value = getComp("administrative_area_level_2");
      document.querySelectorAll("select.form-select[required]")[2].value = getComp("administrative_area_level_1");
    });

    // Actualizar mapa al editar manualmente
    const campos = ["calle", "colonia", "cp", "municipio", "estado"];
    campos.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", actualizarMapa);
    });
  }

  function actualizarMapa() {
    const calle = document.getElementById("calle")?.value || "";
    const colonia = document.getElementById("colonia")?.value || "";
    const cp = document.getElementById("cp")?.value || "";
    const municipio = document.getElementById("municipio")?.value || "";
    const estado = document.getElementById("estado")?.value || "";

    const direccion = `${calle}, ${colonia}, ${cp}, ${municipio}, ${estado}, México`;

    if (calle && colonia && municipio && estado) {
      geocoder.geocode({ address: direccion }, function (results, status) {
        if (status === "OK") {
          const location = results[0].geometry.location;
          map.setCenter(location);
          marker.setPosition(location);
        }
      });
    }
  }
</script>


<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDldEaEtV3NdG-fY-us0SmbBSh8RHibnpU&callback=initMap"
  async defer>
</script>


{% endblock %}
